<html>
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1, user-scalable=no" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<body>
    <div class=all>
        <div class=block>
            <label>Mijn naam:</label>
            <input type="string" id=me size=10 list="watches">
            <span id=msg></span> 
        </div>
        <div class=block>
            <label>Frequency:</label>
            <select id=freq size=1 onchange="startGEO()">
                <option value="-1">Privacy modus</option>
                <option value="5">5 sec</option>
                <option value="10">10 sec</option>
                <option value="15">15 sec</option>
                <option value="30">30 sec</option>
                <option value="60">1 min</option>
                <option value="120">2 min</option>
                <option value="300">5 min</option>
                <option value="600">10 min</option>
                <option value="900">15 min</option>
                <option value="1800">30 min</option>
                <option value="3600">1 uur</option>
                <option value="0">Doe ik zelf</option>
            </select> <br>
        </div>
        <div class=block>
            <label>Zoek naar:</label>
            <select id="name" onchange="calcGEO()">
                {% for item in watches %}
                <option>{{ item }}</option>
                {% endfor %}
            </select> 
        </div>
        <div class=block>
            <label></label>
            <button type="button" onclick="startCompass()">Start Compass iphone</button> <br> <br>
        </div>
        <div class=block>
            <div class=wcircle onclick="calcGEO()"">
                <div id=cir-out class='circle wcircle-out'>&#9660;</div>
                <div id=cir-in class='circle wcircle-in'>&#9650;</div>
                <div class='wcontainer'>
                    <div id=way class="witems">direct</div>
                    <div id=far class="witems">far</div>
                    <div id=age class="witems">age</div>
                    <div id=compass class="witems">compassX</div>
                </div> 
            </div>
        </div>
        <div class=debug>
            <a href="/web"">debug console</a> <br>
            agent:<span id=agent></span> <br>
            my agent:<span id=myagent></span> <br>
            debug:<span id=debug></span> <br>
        </div>  
    <div>
<datalist id=watches>
{% for item in watches %}
<option>{{ item }}</option>
{% endfor %}
</datalist>
</body>
</html>

<style>
  html {
    font-family: sans-serif;
    font-size: large;
  }

  .all {
    text-align: center;
    margin:auto;
    display:block;
  }

  .block {
    text-align: left;
    width: 300px;
    margin:auto;
    margin-bottom: 4px;
  }

  label {
    display: inline-block;
    width: 100px;
    text-align: right;
  }

  .wcircle {
    position: relative; 
    width: 300px; /* 150px; */
    height: 300px; /* 150px; */
    border-radius: 50%;
    user-select: none; /* prevent text highlight */
    cursor: pointer;
  }

  .wcircle>* {
    text-align: center;
    position: absolute;
    border-radius: inherit;
    width: inherit;
    height: inherit;
  }

  .wcircle-out {
    background: #C2DFFF; /* sea blue */;
    transition: 0.3s;
  }

  .wcircle-in {
    background: white;
    transition: 1.3s;
    top: 40px; 
    left: 40px;
    width: calc(300px - 80px); 
    height: calc(300px - 80px);
  }

  .wcontainer {
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    justify-content: center;
    align-items: normal;
    align-content: normal;
  }

  .witems {
    display: block;
    flex-grow: 0;
    flex-shrink: 1;
    flex-basis: auto;
    align-self: auto;
    order: 0;
    padding-bottom: 10px;
   }

   .debug {
        width: 100%;
   }
</style>
{% include 'functions.html' %}
<script>

var debug = document.getElementById('debug');
debug.innerHTML="<br>";

document.getElementById('agent').innerHTML = navigator.userAgent;
agent="desktop";
if (/Android/i.test(navigator.userAgent)) {
    agent="android";
}
if (/iPhone/i.test(navigator.userAgent)) {
    agent="iphone";
}
document.getElementById('myagent').innerHTML = agent;

function clean() {
  var keys = Object.keys(localStorage);
  for (i = 0; key = keys[i]; i++) {
    localStorage.removeItem(key);
  }
}

window.onload = function() {
    if ( localStorage.getItem('me') != null ) {
        document.getElementById('me').value=localStorage.getItem('me');
    }
    if ( localStorage.getItem('freq') != null ) {
        document.getElementById('freq').value=localStorage.getItem('freq');
    }
    startGEO();
};

var myname="";
var myfreq=-1;
var timer;
var friend_updated = "";
var friend_lat;
var friend_lon;
var lat = 0;
var lon = 0;
var cir_in = document.getElementById('cir-in');
var cir_out = document.getElementById('cir-out');
var direction = 0;
var last_compass;
var brng;
var last_dbrng;

function updateCompass() {
    
    var compass = 360 - direction;
    if (Math.abs(compass - last_compass)<180) {
        cir_out.style.webkitTransition = 'all 0.3s ease-in-out';
    } else {
        cir_out.style.webkitTransition = 'none';
    }
    cir_out.style.transform = "rotate(" + compass + "deg)";               
    last_compass = compass;

    var dbrng = compass - brng;
    if (Math.abs(dbrng - last_dbrng)<180) {
        cir_in.style.webkitTransition = 'all 0.1s ease-in-out';
    } else {
        cir_in.style.webkitTransition = 'none';
    }
    cir_in.style.transform = "rotate(" + dbrng + "deg)";
    last_dbrng = dbrng;

    document.getElementById('compass').innerHTML = "c->" + compass.toFixed(0)
        + "  b->" + brng.toFixed(0)
        + "  d->" + dbrng.toFixed(0);

}

function startCompass() {
    
    if (agent == "desktop" ) {
        document.getElementById('compass').innerHTML = "desktop";
        var el = document.getElementsByClassName("circle");
        for(var i = 0; i < el.length; i++) {
            el[i].style.transform = "rotate(" + brng + "deg)";
        }
    }
    
    if (agent == "android" ) {
        window.addEventListener('deviceorientation', (e) => {
            direction = e.webkitCompassHeading;
                updateCompass();
        })
    }

    if (agent == "iphone" ) {
        DeviceOrientationEvent.requestPermission()
        .then(response => {
            if (response == 'granted') {
                window.addEventListener('deviceorientation', (e) => {
                    direction = e.webkitCompassHeading
                        updateCompass();
                })
            }
        })
        .catch(error => {
            debug.innerHTML = debug.innerHTML + " error: " + error + " <br>";
            console.error(error);
        })
    }

}

function startGEO() {

    myfreq=document.getElementById("freq").value;
    clearInterval(timer);

    if (myfreq < 0) {
        document.getElementById("msg").innerHTML = "";
        document.getElementById("me").disabled=false;

    } else {
        document.getElementById("me").disabled=true;
        
        myname=document.getElementById("me").value.trim();
        if (myname.length < 3) {
            alert("Naam is te kort");
            document.getElementById("freq").value=-1;
        } else {
            document.getElementById("me").value=myname;
            localStorage.setItem('me', myname);

            if ( myfreq > 0 ) {
                getGEOandSendToServer();
                timer = setInterval( getGEOandSendToServer() , myfreq * 1000 );
            }
        }
    }
    localStorage.setItem('freq', document.getElementById("freq").value);

}

function calcGEO() {
    document.getElementById("cir-in").style.backgroundColor = "red";

    navigator.geolocation.getCurrentPosition( function( position ) {
        lat = position.coords.latitude;
        lon = position.coords.longitude;

        path = "/get?id=" + document.getElementById("name").value;
        console.log(path);
        fetch(path).then(function (response) {
            document.getElementById("msg").innerHTML = response.status;
            return response.json();
        }).then(function (json) {
            console.log(json);

            friend_updated = json.lastupdated;
            friend_lat = json.latitude;
            friend_lon = json.longitude;

            updateGEO();

            document.getElementById("cir-in").style.backgroundColor = "white";

            startCompass()

        }).catch(function (err) {
            alert("unexpected error" + err);
        })

        if ( myfreq == 0 ) {
            sendToServer();
        }

    }, function(error) {
        alert("Geolocation failed");
    }, gelocationOptions);
}

function updateGEO() {

    dist = distanceInKM(lat, lon, friend_lat, friend_lon);
    if ( dist < 1 ) {
        answer = (dist*1000).toFixed(0) + "m";
    } else {
        answer = dist.toFixed(0) + "km";
    }
    document.getElementById("far").innerHTML = answer;

    last = timeAgo(friend_updated);
    document.getElementById("age").innerHTML = last.short;

    brng = calculateDegrees(lat, lon, friend_lat, friend_lon);
    document.getElementById("way").innerHTML = degToCompass(brng);

}

const gelocationOptions = {
  enableHighAccuracy: true,
  timeout: 5000,
  maximumAge: 0
}

function getGEOandSendToServer() {
    navigator.geolocation.getCurrentPosition( function( position ) {
        lat = position.coords.latitude;
        lon = position.coords.longitude;

        sendToServer();

    }, function(error) {
        alert("Send Geolocation failed");
    }, gelocationOptions);

}

function sendToServer() {

    var path = "/set?id=" + myname + "&longitude=" + lon + "&latitude=" + lat;

    console.log(path);
    fetch(path).then(function (response) {
        document.getElementById("msg").innerHTML = response.status;
        return response.text();
    }).then(function (html) {
        if ( html.length > 0 ) {
            console.log(html);
        }
    }).catch(function (err) {
        console.warn("unexpected error", err)
    })

    // if defined, update the friend's location
    if ( friend_updated != "" ) {
        updateGEO();
    }

}

</script>