<h1>Watch Coordinates</h1>
<div class="block">
    <div class="wrapper">
        <div>
            <label">My Location:</label>
            <span id="mylocation"></span>
        </div>
        <button type="button" onclick="getLocation()">get browser location</button> 
    </div>
    <div class="wrapper">
        <div>
            <label">watch 1:</label>
            <input type="string" id=id1 list="watches"> <br> <br>
            <label">Latitude:</label>
            <input type="number" id=latitude1> <br>
            <label">Longitude:</label>
            <input type="number" id=longitude1> <br>
            <button type="button" onclick="copyMyLocation(1)">copy from my Location</button> <br> <br>
            <label">Last updated:</label>
            <span id="lastupdated1"></span> <br>
            <label">Last Message:</label>
            <spam id=msg1></spam> <br>
            <button type="button" onclick="sendToServer(1)">send to Server</button> 
            <button type="button" onclick="receiveFromServer(1)">get from Server</button> <br> <br>
            <label">Direction:</label>
            <span id="direction1"></span> <br>
            <label">Distance:</label>
            <span id="distance1"></span> <br>
            <label">Last seen:</label>
            <span id="timeago1"></span>
        </div>
        <div>
            <label">watch 2:</label>
            <input type="string" id=id2 list="watches"> <br> <br>
            <label>Latitude:</label>
            <input type="number" id=latitude2> <br>
            <label">Longitude:</label>
            <input type="number" id=longitude2> <br>
            <button type="button" onclick="copyMyLocation(2)">copy from my Location</button> <br> <br>
            <label">Last updated:</label>
            <span id="lastupdated2"></span> <br>
            <label">Last Message:</label>
            <spam id=msg2></spam> <br>
            <button type="button" onclick="sendToServer(2)">send to Server</button> 
            <button type="button" onclick="receiveFromServer(2)">get from Server</button> <br> <br>
            <label">Direction:</label>
            <span id="direction2"></span> <br>
            <label">Distance:</label>
            <span id="distance2"></span> <br>
            <label">Last seen:</label>
            <span id="timeago2"></span>
        </div>
    </div>  
    <div class="wrapper">
        <button id=timerbutton type="button" onclick="buttonTimer()">Stop Auto-Update</button> 
    </div>
</div>
<datalist id=watches>
{% for item in watches %}
    <option>{{ item }}</option>
{% endfor %}
</datalist>

<style>
  page {
      size: A4 landscape;
      margin: 0;
  }
  html, body {
      margin: 0;      
  }
  html {
    font-family: sans-serif;
    font-size: small;
    background: cyan;
  }
  body {
      width: 200mm;
      height: 210mm;     
      background: white;
      margin-top: -1px;
  } 
  h1 {
      text-align: center;
  }
  .wrapper {
    display: flex;
    flex-direction: row;
    flex-wrap: nowrap;
    justify-content: space-between;
    margin: 0 4rem 2rem;
  }
</style>

<script>

var lat = 0;
var lng = 0;

// calculate distance in km for two geocoordinates
function distanceInKM(lat1, lon1, lat2, lon2) {
    if ((lat1 == lat2) && (lon1 == lon2)) {
        dist = 0;
    } else {
        var radlat1 = Math.PI * lat1/180;
        var radlat2 = Math.PI * lat2/180;
        var theta = lon1-lon2;
        var radtheta = Math.PI * theta/180;
        var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
        if (dist > 1) {
            dist = 1;
        }
        dist = Math.acos(dist);
        dist = dist * 180/Math.PI;
        dist = dist * 60 * 1.1515 * 1.609344;
    }
    return dist;
}

function calculateDistance(a, b) {
    var lat1 = document.getElementById("latitude" + a).value;
    var lon1 = document.getElementById("longitude" + a).value;
    var lat2 = document.getElementById("latitude" + b).value;
    var lon2 = document.getElementById("longitude" + b).value;
    
    dist = distanceInKM(lat1, lon1, lat2, lon2);
    if ( dist < 1 ) {
        answer = (dist*1000).toFixed(2) + " m";
    } else {
        answer = dist.toFixed(2) + " km";
    }
    document.getElementById("distance" + a).innerHTML = answer;
}

// function to explain the time difference between to dates
function timeAgo(datetime) {
    var msPerMinute = 60 * 1000;
    var msPerHour = msPerMinute * 60;
    var msPerDay = msPerHour * 24;
    var msPerMonth = msPerDay * 30;
    var msPerYear = msPerDay * 365;

    var elapsed = new Date() - datetime;

    if (elapsed < msPerMinute) {
        return Math.round(elapsed/1000) + ' seconds ago';   
    }
    else if (elapsed < msPerHour) {
        return Math.round(elapsed/msPerMinute) + ' minutes ago';   
    }
    else if (elapsed < msPerDay) {
        return Math.round(elapsed/msPerHour) + ' hours ago';   
    }
    else if (elapsed < msPerMonth) {
        return Math.round(elapsed/msPerDay) + ' days ago';   
    }
    else if (elapsed < msPerYear) {
        return Math.round(elapsed/msPerMonth) + ' months ago';   
    }
    else {
        return Math.round(elapsed/msPerYear) + ' years ago';   
    }
}

// calculate the direction in degrees for two geocoordinates
function calculateDegrees(lat1, lng1, lat2, lng2) {
    y = Math.sin(lng2 - lng1) * Math.cos(lat2);
    x = Math.cos(lat1) * Math.sin(lat2) -
            Math.sin(lat1) * Math.cos(lat2) * Math.cos(lng2 - lng1);
    brng = Math.atan2(y, x);
    brng = brng * 180 / Math.PI;
    brng = (brng + 360) % 360;
    return brng;
}

// display bearing in windirection words
function degToCompass(num) {
    var val = Math.floor((num / 22.5) + 0.5);
    var arr = ["N", "NNE", "NE", "ENE", "E", "ESE", "SE", "SSE", "S", "SSW", "SW", "WSW", "W", "WNW", "NW", "NNW"];
    return arr[(val % 16)];
}

// update Direction fields
function calculateDirection(a, b) {
  var lat1 = document.getElementById("latitude" + a).value * Math.PI / 180;
  var lng1 = document.getElementById("longitude" + a).value * Math.PI / 180;
  var lat2 = document.getElementById("latitude" + b).value * Math.PI / 180;
  var lng2 = document.getElementById("longitude" + b).value * Math.PI / 180;
  brng=calculateDegrees(lat1, lng1, lat2, lng2);
  document.getElementById("direction" + a).innerHTML = "(" + brng.toFixed(0) + "Â°) walk " + degToCompass(brng);
}

const gelocationOptions = {
  enableHighAccuracy: true,
  timeout: 5000,
  maximumAge: 0
}

function getLocation(i) {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition( function( position ) {
        lat = position.coords.latitude;
        lng = position.coords.longitude;
        document.getElementById("mylocation").innerHTML = "Latitude: " + lat + " Longitude: " + lng;
        
    }, function(error) {
        alert("Geolocation failed");
    }, gelocationOptions)
  } else {
     alert("Geolocation not supported.");
  }
}

function copyMyLocation(i) {
    document.getElementById("msg" + i).innerHTML = "";
    document.getElementById("latitude" + i).value = lat;
    document.getElementById("longitude" + i).value = lng;
}

// set a timer for ever 1000 milliseconds
function updateFields() {
    document.getElementById("timeago1").innerHTML = timeAgo(new Date(document.getElementById("lastupdated1").innerHTML));
    document.getElementById("timeago2").innerHTML = timeAgo(new Date(document.getElementById("lastupdated2").innerHTML));
    calculateDirection(2, 1);
    calculateDirection(1, 2);
    calculateDistance(2, 1);
    calculateDistance(1, 2);
}

var timer = setInterval( updateFields , 1000 );
var timeron = true;

function buttonTimer() {
    if ( timeron ) {
        clearInterval(timer);
        document.getElementById("timerbutton").innerHTML = "Start Auto-Update";
        timeron = false;
    } else {
        timer = setInterval( updateFields , 1000 );
        document.getElementById("timerbutton").innerHTML = "Stop Auto-Update";
        timeron = true;
    }
}

function receiveFromServer(i) {
    document.getElementById("msg" + i).innerHTML = "";
    path = "/get?id=" + document.getElementById("id" +i).value;

    console.log(path);
    fetch(path).then(function (response) {
        document.getElementById("msg" + i).innerHTML = response.status;
        return response.text();
    }).then(function (answer) {
        console.log("answer", answer);

        if ( answer.length > 0 ) {
            var json = JSON.parse(answer);
            
            document.getElementById("lastupdated" + i).innerHTML = json.lastupdated;
            document.getElementById("latitude" + i).value = json.latitude;
            document.getElementById("longitude" + i).value = json.longitude;
        }
        
    }).catch(function (err) {
        document.getElementById("msg" + i).innerHTML = "unexpected error" + err;
        console.warn("unexpected error", err)
    })
}

function sendToServer(i) {
    document.getElementById("msg" + i).innerHTML = "";
    var path = "/set?id=" + document.getElementById("id" + i).value
     + "&longitude=" + document.getElementById("longitude" + i).value
      + "&latitude=" + document.getElementById("latitude" + i).value;

    console.log(path);
    fetch(path).then(function (response) {
        document.getElementById("msg" + i).innerHTML = response.status;
        return response.text();
    }).then(function (html) {
        if ( html.length > 0 ) {
            console.log(html);
        }
    }).catch(function (err) {
        console.warn("unexpected error", err)
    })
}

</script>