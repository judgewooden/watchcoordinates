<html>
<meta id="viewport" name="viewport" content="width=device-width, initial-scale=1">
<body>
    <div>
        <div class=block>
            <label>Naam:</label>
            <input type="string" id=me size=10>
            <span id=msg></span> 
        </div>
        <div class=block>
            <label>Frequency:</label>
            <select id=freq size=1>
                <option value="-1">Privacy modus</option>
                <option value="5">5 sec</option>
                <option value="10">10 sec</option>
                <option value="15">15 sec</option>
                <option value="30">30 sec</option>
                <option value="60">1 min</option>
                <option value="120">2 min</option>
                <option value="300">5 min</option>
                <option value="600">10 min</option>
                <option value="900">15 min</option>
                <option value="1800">30 min</option>
                <option value="3600">1 uur</option>
                <!-- <option value="0">Doe ik zelf</option> -->
            </select> <br>
        </div>
        <div class=block>
            <label></label>
            <button id=start type="button" onclick="startGEO()">Start</button> <br> <br>
        </div>
        <div class=block>
            <label></label>
            <a href="/web"">debug console</a>
        </div>  
        <div class=block>
            <label>Zoek naar:</label>
            <select id="name" onchange="calcGEO()">
                {% for item in watches %}
                <option>{{ item }}</option>
                {% endfor %}
            </select> <br> <br> <br>
        </div>
    </div>
    <div class=center>
        <div class=w-circle onclick="calcGEO()"">
            <div id=cir1-out class='circle w-circle-out'>&#9660;</div>
            <div id=cir1-in class='circle w-circle-in'>&#9650;</div>
            <div class='w-circle flex-container'>
                <div id=way class="w-way flex-items">direct</div>
                <div id=far class="w-far flex-items">far</div>
                <div id=age class="w-age flex-items">age</div>
            </div>
        </div>
    <div>
</body>
</html>

<style>
  html {
    font-family: sans-serif;
    /* font-size: small; */
    /* height: 100vh;
    width: 100vw; */
  }

  .block {
    margin-bottom: 4px;
  }

  label {
    display: inline-block;
    width: 100px;
    text-align: right;
  }

  .center {
    text-align: center;
  }

  .w-circle {
    position: relative;
    width: 300px; /* 150px; */
    height: 300px; /* 150px; */
    border-radius: 50%;
    user-select: none; /* prevent text highlight */
    cursor: pointer;
  }

  .w-circle>* {
    text-align: center;
    position: absolute;
    border-radius: inherit;
    width: inherit;
    height: inherit;
  }

  .w-circle-out {
    background: #C2DFFF; /* sea blue */;
    transition: 1.3s;
  }

  .w-circle-in {
    background: white;
    transition: 0.3s;
    top: 40px; 
    left: 40px;
    width: calc(300px - 80px); 
    height: calc(300px - 80px);
  }

  .flex-container {
    display: flex;
    flex-direction: column;
    flex-wrap: nowrap;
    justify-content: center;
    align-items: normal;
    align-content: normal;
  }

 .w-way {
    top: 50px;
    height: 20px;
  }

  .w-far {
    top: 70px;
    height: 20px;
  }

  .w-age {
    top: 90px;
    height: 20px; */
  }

</style>
{% include 'functions.html' %}

<script>

function clean() {
  var keys = Object.keys(localStorage);
  for (i = 0; key = keys[i]; i++) {
    localStorage.removeItem(key);
  }
}

window.onload = function() {
    console.log(localStorage.getItem('me'), "loaded");
    if ( localStorage.getItem('me') != null ) {
        document.getElementById('me').value=localStorage.getItem('me');
    }
};

var myname="";
var myfreq=-1;
var running=false;
var lat = 0;
var lon = 0;
var timer;
var friend_updated;
var friend_lat;
var friend_lon;

function startGEO() {
    if (running) {
        clearInterval(timer);
        running=false;
        document.getElementById("start").innerHTML="Start";
        document.getElementById("msg").innerHTML = "";

    } else {
        myfreq=document.getElementById("freq").value;
        if ( myfreq < 1 ) {
            alert("Selecteer een frequentie");
            return;
        }
        
        myname=document.getElementById("me").value.trim();
        if (myname.length < 3) {
            alert("Naam is te kort");
            return;
        }
        document.getElementById("me").value=myname;
        localStorage.setItem('me', myname);

        // disable fields here
        sendToServer();
        timer = setInterval( sendToServer , myfreq * 1000 );
        running=true;
        document.getElementById("start").innerHTML="Stop";
    }
}

function calcGEO() {
    console.log("calcGEO");
    if (freq != -1) { //privacy mode
        sendToServer();
    } else {
        updateGEO();
    }

    path = "/get?id=" + document.getElementById("name").value;
    console.log(path);
    fetch(path).then(function (response) {
        document.getElementById("msg").innerHTML = response.status;
        return response.text();
    }).then(function (answer) {
        console.log("answer", answer);

        if ( answer.length > 0 ) {
            var json = JSON.parse(answer);
            
            friend_updated = json.lastupdated;
            friend_lat = json.latitude;
            friend_lon = json.longitude;
        }

        dist = distanceInKM(lat, lon, friend_lat, friend_lon);
        if ( dist < 1 ) {
            answer = (dist*1000).toFixed(0) + "m";
        } else {
            answer = dist.toFixed(0) + "km";
        }
        document.getElementById("far").innerHTML = answer;

        last = timeAgo(new Date(friend_updated));
        document.getElementById("age").innerHTML = last.short;

        brng = calculateDegrees(lat, lon, friend_lat, friend_lon);
        document.getElementById("way").innerHTML = degToCompass(brng);
        var el = document.getElementsByClassName("circle");
        for(var i = 0; i < el.length; i++) {
            el[i].style.transform = "rotate(" + brng + "deg)";
        }

    }).catch(function (err) {
        aler("unexpected error" + err);
    })
}

const gelocationOptions = {
  enableHighAccuracy: true,
  timeout: 5000,
  maximumAge: 0
}

function updateGEO() {
    // uncomment this to work on production
    // lat = 12.34;
    // lon = 33.44;
    // return true;
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition( function( position ) {
        lat = position.coords.latitude;
        lon = position.coords.longitude;
        return true;
    }, function(error) {
        alert("Geolocation failed");
        return false;
    }, gelocationOptions)
  } else {
        alert("Geolocation not supported.");
        return false;
  }
}

function sendToServer() {
    if ( updateGEO() == false ) return;
    var path = "/set?id=" + myname + "&longitude=" + lon + "&latitude=" + lat;

    console.log(path);
    fetch(path).then(function (response) {
        document.getElementById("msg").innerHTML = response.status;
        return response.text();
    }).then(function (html) {
        if ( html.length > 0 ) {
            console.log(html);
        }
    }).catch(function (err) {
        console.warn("unexpected error", err)
    })
}

</script>